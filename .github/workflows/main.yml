name: CI/CD - Python API (Vercel Serverless)

on:
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout do código
        uses: actions/checkout@v3

      - name: Build da imagem Docker
        # O caminho do contexto Docker foi ajustado para './lab_api'
        run: docker build -t lab-final:latest ./lab_api

  test:
    runs-on: ubuntu-latest
    needs: build # Garante que a imagem foi construída

    steps:
      - name: Checkout do código
        uses: actions/checkout@v3

      # NÃO PRECISA MAIS RECONSTRUIR A IMAGEM!
      # Se você não fizer um push para um registry, o Docker não compartilha imagens entre jobs.
      # A maneira mais simples e eficaz é rodar a etapa de build e teste no mesmo job,
      # ou usar o Artifacts para salvar a imagem, mas para manter a estrutura original, vamos
      # RECONSTRUIR a imagem APENAS para o teste (apesar da ineficiência).
      
      - name: Rodar testes dentro do Docker
        run: |
          # O caminho do Docker build foi ajustado para './lab_api'
          docker build -t lab-final:latest ./lab_api
          
          # Rodar o pytest dentro do contêiner
          docker run --rm lab-final:latest pytest -q

  deploy:
    runs-on: ubuntu-latest
    # O deploy DEVE depender do 'test' para garantir que os testes passaram.
    needs: test 

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      # --- Configuração para Vercel Serverless ---
      - name: Instalar Node.js e Vercel CLI
        uses: actions/setup-node@v4
        with:
          node-version: '20' 

      - name: Instalar Vercel CLI
        run: npm install -g vercel
        
      # O Vercel usará o vercel.json e o app.py/index.py da pasta 'lab_api'
      # para construir e implantar a função serverless Python.
      - name: Deploy para a Vercel
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          vercel --token=$VERCEL_TOKEN --prod --confirm
